<!doctype html>
<html lang="id" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Peta Geografis Trenggalek - Standalone</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&amp;display=swap" rel="stylesheet">
  <style>
    body {
      box-sizing: border-box;
      font-family: 'Plus Jakarta Sans', sans-serif;
    }
    
    .region {
      transition: all 0.3s ease;
      cursor: pointer;
    }
    
    .region:hover {
      filter: brightness(1.15);
      transform: scale(1.02);
      transform-origin: center;
    }
    
    .region.active {
      filter: brightness(1.2);
      stroke-width: 3;
    }
    
    .legend-item {
      transition: transform 0.2s ease;
    }
    
    .legend-item:hover {
      transform: translateX(5px);
    }
    
    .info-card {
      animation: slideIn 0.3s ease;
    }
    
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .pulse-dot {
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.7; transform: scale(1.1); }
    }
    
    .tooltip {
      position: absolute;
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      pointer-events: none;
      z-index: 100;
      white-space: nowrap;
    }
    
    .layer-btn {
      transition: all 0.2s ease;
    }
    
    .layer-btn.active {
      transform: scale(1.05);
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }
    
    /* Loading Spinner */
    .loader {
      border: 3px solid #f3f3f3;
      border-radius: 50%;
      border-top: 3px solid #3498db;
      width: 20px;
      height: 20px;
      -webkit-animation: spin 2s linear infinite; /* Safari */
      animation: spin 2s linear infinite;
      display: inline-block;
      vertical-align: middle;
      margin-right: 8px;
    }
    
    /* Modal Transition */
    .modal {
      transition: opacity 0.25s ease;
    }
    body.modal-active {
      overflow-x: hidden;
      overflow-y: visible !important;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Custom Scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
    }
    ::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.1); 
    }
    ::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.3); 
      border-radius: 4px;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.5); 
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body class="h-full bg-gradient-to-br from-emerald-900 via-teal-800 to-cyan-900 overflow-y-auto overflow-x-hidden">
  
  <!-- Navigation -->
  <div class="fixed top-4 right-4 z-50 flex flex-wrap justify-end gap-2">
    <button onclick="switchMode('map')" id="btn-mode-map" class="px-4 py-2 bg-emerald-600 text-white rounded-lg text-sm font-medium hover:bg-emerald-700 shadow-lg transition-colors ring-2 ring-white/20"> ğŸ—ºï¸ Peta </button> 
    <button onclick="switchMode('soal')" id="btn-mode-soal" class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 shadow-lg transition-colors ring-2 ring-white/20"> ğŸ“ Soal Pengayaan </button> 
    <button onclick="switchMode('nilai')" id="btn-mode-nilai" class="px-4 py-2 bg-yellow-600 text-white rounded-lg text-sm font-medium hover:bg-yellow-700 shadow-lg transition-colors ring-2 ring-white/20"> ğŸ“ Nilai Siswa </button>
    <button onclick="switchMode('penilaian')" id="btn-mode-penilaian" class="px-4 py-2 bg-purple-600 text-white rounded-lg text-sm font-medium hover:bg-purple-700 shadow-lg transition-colors ring-2 ring-white/20"> ğŸ‘¨â€ğŸ« Penilaian Guru </button>
    <button onclick="refreshData()" id="btn-refresh" class="px-4 py-2 bg-teal-600 text-white rounded-lg text-sm font-medium hover:bg-teal-700 shadow-lg transition-colors" title="Perbarui Data"> ğŸ”„ Refresh </button>
  </div>

  <!-- MODE: MAP -->
  <div id="mode-map" class="min-h-full w-full p-4 md:p-6 pb-20">
    <header class="text-center mb-4">
    <h1 id="map-title" class="text-2xl md:text-3xl font-bold text-white drop-shadow-lg">ğŸ—ºï¸ Peta Geografis Kabupaten Trenggalek</h1>
    <p class="text-emerald-200 text-sm md:text-base mt-1">Provinsi Jawa Timur â€¢ Simulasi Interaktif untuk Pembelajaran</p>
    </header>
    <div class="flex flex-col lg:flex-row gap-4 h-auto">
    <div class="lg:w-2/3 bg-white/10 backdrop-blur-sm rounded-2xl p-4 border border-white/20">
      <div class="flex flex-wrap gap-2 mb-3">
        <button onclick="toggleLayer('topography')" id="btn-topography" class="layer-btn active px-3 py-1.5 bg-emerald-500 text-white rounded-lg text-xs font-medium hover:bg-emerald-600"> ğŸ”ï¸ Topografi </button> 
        <button onclick="toggleLayer('rivers')" id="btn-rivers" class="layer-btn active px-3 py-1.5 bg-blue-500 text-white rounded-lg text-xs font-medium hover:bg-blue-600"> ğŸŒŠ Sungai </button> 
        <button onclick="toggleLayer('cities')" id="btn-cities" class="layer-btn active px-3 py-1.5 bg-amber-500 text-white rounded-lg text-xs font-medium hover:bg-amber-600"> ğŸ˜ï¸ Kecamatan </button> 
        <button onclick="toggleLayer('tourism')" id="btn-tourism" class="layer-btn px-3 py-1.5 bg-pink-500 text-white rounded-lg text-xs font-medium hover:bg-pink-600"> ğŸ–ï¸ Wisata </button>
      </div>
      <div class="relative bg-gradient-to-b from-sky-100 to-sky-200 rounded-xl overflow-hidden shadow-inner" id="map-container">
      <svg viewBox="0 0 800 500" class="w-full h-auto" id="trenggalek-map">
        <!-- Peta SVG -->
        <defs>
        <linearGradient id="oceanGrad" x1="0%" y1="0%" x2="0%" y2="100%">
          <stop offset="0%" style="stop-color:#0ea5e9;stop-opacity:0.3" />
          <stop offset="100%" style="stop-color:#0369a1;stop-opacity:0.6" />
        </linearGradient>
        <linearGradient id="mountainGrad" x1="0%" y1="0%" x2="0%" y2="100%">
          <stop offset="0%" style="stop-color:#166534" />
          <stop offset="100%" style="stop-color:#14532d" />
        </linearGradient>
        <linearGradient id="hillGrad" x1="0%" y1="0%" x2="0%" y2="100%">
          <stop offset="0%" style="stop-color:#22c55e" />
          <stop offset="100%" style="stop-color:#16a34a" />
        </linearGradient>
        <linearGradient id="lowlandGrad" x1="0%" y1="0%" x2="0%" y2="100%">
          <stop offset="0%" style="stop-color:#86efac" />
          <stop offset="100%" style="stop-color:#4ade80" />
        </linearGradient>
        <pattern id="wavePattern" patternUnits="userSpaceOnUse" width="20" height="10">
          <path d="M0,5 Q5,0 10,5 T20,5" fill="none" stroke="rgba(255,255,255,0.3)" stroke-width="1" />
        </pattern>
        </defs> 
        <g id="base-sketch">
        <path d="M100,150 L50,200 L40,250 L50,300 L60,340 L80,360 L150,370 L250,375 L350,370 L450,375 L550,370 L650,375 L720,365 L750,350 L760,310 L750,250 L720,200 L680,160 L600,150 L550,140 L500,135 L450,130 L400,135 L350,140 L300,145 L250,150 L200,155 L150,152 Z" fill="none" stroke="#1e3a5f" stroke-width="3" stroke-dasharray="8,4" opacity="0.4" /> 
        <g opacity="0.2">
          <line x1="200" y1="100" x2="200" y2="380" stroke="#1e3a5f" stroke-width="1" stroke-dasharray="4,4" />
          <line x1="300" y1="100" x2="300" y2="380" stroke="#1e3a5f" stroke-width="1" stroke-dasharray="4,4" />
          <line x1="400" y1="100" x2="400" y2="380" stroke="#1e3a5f" stroke-width="1" stroke-dasharray="4,4" />
          <line x1="500" y1="100" x2="500" y2="380" stroke="#1e3a5f" stroke-width="1" stroke-dasharray="4,4" />
          <line x1="600" y1="100" x2="600" y2="380" stroke="#1e3a5f" stroke-width="1" stroke-dasharray="4,4" />
          <line x1="700" y1="100" x2="700" y2="380" stroke="#1e3a5f" stroke-width="1" stroke-dasharray="4,4" />
          <line x1="50" y1="150" x2="750" y2="150" stroke="#1e3a5f" stroke-width="1" stroke-dasharray="4,4" />
          <line x1="50" y1="200" x2="750" y2="200" stroke="#1e3a5f" stroke-width="1" stroke-dasharray="4,4" />
          <line x1="50" y1="250" x2="750" y2="250" stroke="#1e3a5f" stroke-width="1" stroke-dasharray="4,4" />
          <line x1="50" y1="300" x2="750" y2="300" stroke="#1e3a5f" stroke-width="1" stroke-dasharray="4,4" />
          <line x1="50" y1="350" x2="750" y2="350" stroke="#1e3a5f" stroke-width="1" stroke-dasharray="4,4" />
        </g> 
        <path d="M80,360 Q150,365 250,368 Q350,362 450,368 Q550,363 650,370 Q710,365 750,358" fill="none" stroke="#0369a1" stroke-width="2" stroke-dasharray="6,3" opacity="0.5" /> 
        <ellipse cx="400" cy="220" rx="200" ry="80" fill="none" stroke="#166534" stroke-width="1.5" stroke-dasharray="5,3" opacity="0.3" />
        <ellipse cx="400" cy="220" rx="150" ry="60" fill="none" stroke="#166534" stroke-width="1.5" stroke-dasharray="5,3" opacity="0.3" />
        <ellipse cx="400" cy="220" rx="100" ry="40" fill="none" stroke="#166534" stroke-width="1.5" stroke-dasharray="5,3" opacity="0.3" />
        <ellipse cx="200" cy="200" rx="80" ry="50" fill="none" stroke="#166534" stroke-width="1.5" stroke-dasharray="5,3" opacity="0.3" />
        <ellipse cx="550" cy="180" rx="70" ry="45" fill="none" stroke="#166534" stroke-width="1.5" stroke-dasharray="5,3" opacity="0.3" />
        </g> 
        <rect x="0" y="380" width="800" height="120" fill="url(#oceanGrad)" /> 
        <rect x="0" y="380" width="800" height="120" fill="url(#wavePattern)" /> 
        <text x="400" y="450" text-anchor="middle" fill="white" font-size="16" font-weight="bold" opacity="0.8">
          ğŸŒŠ SAMUDRA HINDIA
        </text> 
        <g id="topography-layer">
        <path class="region" id="region-coastal" d="M50,350 Q100,360 200,355 Q300,350 400,360 Q500,355 600,365 Q700,360 750,350 L750,380 Q600,390 400,385 Q200,390 50,380 Z" fill="url(#lowlandGrad)" stroke="#15803d" stroke-width="2" onclick="showRegionInfo('coastal')" onmouseenter="showTooltip(event, 'Dataran Rendah Pesisir')" onmouseleave="hideTooltip()" /> 
        <path class="region" id="region-hills" d="M80,250 Q150,280 250,270 Q350,260 450,275 Q550,265 650,280 Q720,270 750,250 L750,350 Q650,360 450,355 Q250,360 50,350 L50,260 Z" fill="url(#hillGrad)" stroke="#166534" stroke-width="2" onclick="showRegionInfo('hills')" onmouseenter="showTooltip(event, 'Perbukitan')" onmouseleave="hideTooltip()" /> 
        <path class="region" id="region-mountains" d="M100,150 L150,200 Q200,180 250,190 L300,160 Q350,140 400,150 L450,130 Q500,120 550,140 L600,150 Q650,160 700,145 L720,180 Q680,220 600,230 Q500,225 400,235 Q300,230 200,240 Q120,235 80,250 L100,150 Z" fill="url(#mountainGrad)" stroke="#14532d" stroke-width="2" onclick="showRegionInfo('mountains')" onmouseenter="showTooltip(event, 'Pegunungan')" onmouseleave="hideTooltip()" /> 
        <polygon points="400,90 420,140 380,140" fill="#0f4c2e" stroke="#0a3622" stroke-width="1" />
        <polygon points="550,100 575,145 525,145" fill="#0f4c2e" stroke="#0a3622" stroke-width="1" />
        <polygon points="250,110 275,160 225,160" fill="#0f4c2e" stroke="#0a3622" stroke-width="1" />
        </g> 
        <g id="rivers-layer">
        <path d="M300,130 Q320,180 310,220 Q290,270 280,320 Q270,360 260,390" fill="none" stroke="#0ea5e9" stroke-width="4" stroke-linecap="round" opacity="0.8" class="region" onclick="showRegionInfo('ngasinan')" onmouseenter="showTooltip(event, 'Sungai Ngasinan')" onmouseleave="hideTooltip()" /> 
        <path d="M500,140 Q480,190 490,240 Q510,290 520,340 Q530,370 540,395" fill="none" stroke="#0ea5e9" stroke-width="3.5" stroke-linecap="round" opacity="0.8" class="region" onclick="showRegionInfo('tawing')" onmouseenter="showTooltip(event, 'Sungai Tawing')" onmouseleave="hideTooltip()" /> 
        <path d="M200,180 Q230,200 260,220" fill="none" stroke="#38bdf8" stroke-width="2" opacity="0.6" />
        <path d="M380,160 Q360,200 340,230" fill="none" stroke="#38bdf8" stroke-width="2" opacity="0.6" />
        <path d="M600,170 Q580,210 560,250" fill="none" stroke="#38bdf8" stroke-width="2" opacity="0.6" />
        </g> 
        <g id="cities-layer">
        <g class="region" onclick="showRegionInfo('trenggalek-city')" onmouseenter="showTooltip(event, 'Kec. Trenggalek (Ibu Kota)')" onmouseleave="hideTooltip()">
          <circle cx="350" cy="280" r="12" fill="#fbbf24" stroke="#b45309" stroke-width="2" />
          <circle cx="350" cy="280" r="6" fill="#b45309" />
          <text x="350" y="305" text-anchor="middle" fill="#1e3a5f" font-size="11" font-weight="bold">
          TRENGGALEK
          </text>
        </g> 
        <g class="region" onclick="showRegionInfo('gandusari')" onmouseenter="showTooltip(event, 'Kec. Gandusari')" onmouseleave="hideTooltip()">
          <circle cx="200" cy="200" r="8" fill="#fb923c" stroke="#c2410c" stroke-width="2" />
          <text x="200" y="220" text-anchor="middle" fill="#1e3a5f" font-size="9" font-weight="600">
          Gandusari
          </text>
        </g> 
        <g class="region" onclick="showRegionInfo('watulimo')" onmouseenter="showTooltip(event, 'Kec. Watulimo')" onmouseleave="hideTooltip()">
          <circle cx="600" cy="320" r="8" fill="#fb923c" stroke="#c2410c" stroke-width="2" />
          <text x="600" y="340" text-anchor="middle" fill="#1e3a5f" font-size="9" font-weight="600">
          Watulimo
          </text>
        </g> 
        <g class="region" onclick="showRegionInfo('kampak')" onmouseenter="showTooltip(event, 'Kec. Kampak')" onmouseleave="hideTooltip()">
          <circle cx="450" cy="250" r="8" fill="#fb923c" stroke="#c2410c" stroke-width="2" />
          <text x="450" y="270" text-anchor="middle" fill="#1e3a5f" font-size="9" font-weight="600">
          Kampak
          </text>
        </g> 
        <g class="region" onclick="showRegionInfo('munjungan')" onmouseenter="showTooltip(event, 'Kec. Munjungan')" onmouseleave="hideTooltip()">
          <circle cx="700" cy="340" r="8" fill="#fb923c" stroke="#c2410c" stroke-width="2" />
          <text x="700" y="360" text-anchor="middle" fill="#1e3a5f" font-size="9" font-weight="600">
          Munjungan
          </text>
        </g> 
        <g class="region" onclick="showRegionInfo('panggul')" onmouseenter="showTooltip(event, 'Kec. Panggul')" onmouseleave="hideTooltip()">
          <circle cx="150" cy="330" r="8" fill="#fb923c" stroke="#c2410c" stroke-width="2" />
          <text x="150" y="350" text-anchor="middle" fill="#1e3a5f" font-size="9" font-weight="600">
          Panggul
          </text>
        </g> 
        <g class="region" onclick="showRegionInfo('dongko')" onmouseenter="showTooltip(event, 'Kec. Dongko')" onmouseleave="hideTooltip()">
          <circle cx="280" cy="310" r="8" fill="#fb923c" stroke="#c2410c" stroke-width="2" />
          <text x="280" y="330" text-anchor="middle" fill="#1e3a5f" font-size="9" font-weight="600">
          Dongko
          </text>
        </g> 
        <g class="region" onclick="showRegionInfo('pule')" onmouseenter="showTooltip(event, 'Kec. Pule')" onmouseleave="hideTooltip()">
          <circle cx="520" cy="190" r="8" fill="#fb923c" stroke="#c2410c" stroke-width="2" />
          <text x="520" y="210" text-anchor="middle" fill="#1e3a5f" font-size="9" font-weight="600">
          Pule
          </text>
        </g> 
        <g class="region" onclick="showRegionInfo('karangan')" onmouseenter="showTooltip(event, 'Kec. Karangan')" onmouseleave="hideTooltip()">
          <circle cx="420" cy="320" r="8" fill="#fb923c" stroke="#c2410c" stroke-width="2" />
          <text x="420" y="340" text-anchor="middle" fill="#1e3a5f" font-size="9" font-weight="600">
          Karangan
          </text>
        </g> 
        <g class="region" onclick="showRegionInfo('pogalan')" onmouseenter="showTooltip(event, 'Kec. Pogalan')" onmouseleave="hideTooltip()">
          <circle cx="300" cy="240" r="8" fill="#fb923c" stroke="#c2410c" stroke-width="2" />
          <text x="300" y="260" text-anchor="middle" fill="#1e3a5f" font-size="9" font-weight="600">
          Pogalan
          </text>
        </g> 
        <g class="region" onclick="showRegionInfo('tugu')" onmouseenter="showTooltip(event, 'Kec. Tugu')" onmouseleave="hideTooltip()">
          <circle cx="380" cy="220" r="8" fill="#fb923c" stroke="#c2410c" stroke-width="2" />
          <text x="380" y="240" text-anchor="middle" fill="#1e3a5f" font-size="9" font-weight="600">
          Tugu
          </text>
        </g> 
        <g class="region" onclick="showRegionInfo('durenan')" onmouseenter="showTooltip(event, 'Kec. Durenan')" onmouseleave="hideTooltip()">
          <circle cx="550" cy="280" r="8" fill="#fb923c" stroke="#c2410c" stroke-width="2" />
          <text x="550" y="300" text-anchor="middle" fill="#1e3a5f" font-size="9" font-weight="600">
          Durenan
          </text>
        </g> 
        <g class="region" onclick="showRegionInfo('bendungan')" onmouseenter="showTooltip(event, 'Kec. Bendungan')" onmouseleave="hideTooltip()">
          <circle cx="180" cy="280" r="8" fill="#fb923c" stroke="#c2410c" stroke-width="2" />
          <text x="180" y="300" text-anchor="middle" fill="#1e3a5f" font-size="9" font-weight="600">
          Bendungan
          </text>
        </g> 
        <g class="region" onclick="showRegionInfo('suruh')" onmouseenter="showTooltip(event, 'Kec. Suruh')" onmouseleave="hideTooltip()">
          <circle cx="620" cy="220" r="8" fill="#fb923c" stroke="#c2410c" stroke-width="2" />
          <text x="620" y="240" text-anchor="middle" fill="#1e3a5f" font-size="9" font-weight="600">
          Suruh
          </text>
        </g> 
        </g> 
        <g id="tourism-layer" style="display: none;">
        <g class="region pulse-dot" onclick="showRegionInfo('prigi')" onmouseenter="showTooltip(event, 'Pantai Prigi')" onmouseleave="hideTooltip()">
          <circle cx="550" cy="365" r="10" fill="#ec4899" stroke="white" stroke-width="2" />
          <text x="550" y="365" text-anchor="middle" dominant-baseline="middle" fill="white" font-size="10">
          ğŸ–ï¸
          </text>
        </g> 
        <g class="region pulse-dot" onclick="showRegionInfo('karanggongso')" onmouseenter="showTooltip(event, 'Pantai Karanggongso')" onmouseleave="hideTooltip()">
          <circle cx="620" cy="370" r="10" fill="#ec4899" stroke="white" stroke-width="2" />
          <text x="620" y="370" text-anchor="middle" dominant-baseline="middle" fill="white" font-size="10">
          ğŸ–ï¸
          </text>
        </g> 
        <g class="region pulse-dot" onclick="showRegionInfo('goalowo')" onmouseenter="showTooltip(event, 'Goa Lowo')" onmouseleave="hideTooltip()">
          <circle cx="380" cy="200" r="10" fill="#8b5cf6" stroke="white" stroke-width="2" />
          <text x="380" y="200" text-anchor="middle" dominant-baseline="middle" fill="white" font-size="10">
          ğŸ¦‡
          </text>
        </g> 
        <g class="region pulse-dot" onclick="showRegionInfo('jurug')" onmouseenter="showTooltip(event, 'Air Terjun Jurug')" onmouseleave="hideTooltip()">
          <circle cx="240" cy="180" r="10" fill="#06b6d4" stroke="white" stroke-width="2" />
          <text x="240" y="180" text-anchor="middle" dominant-baseline="middle" fill="white" font-size="10">
          ğŸ’§
          </text>
        </g> 
        </g> 
        <g transform="translate(720, 60)">
        <circle cx="0" cy="0" r="30" fill="white" opacity="0.9" stroke="#1e3a5f" stroke-width="2" />
        <polygon points="0,-25 5,-5 -5,-5" fill="#dc2626" />
        <polygon points="0,25 5,5 -5,5" fill="#1e3a5f" />
        <polygon points="-25,0 -5,5 -5,-5" fill="#1e3a5f" />
        <polygon points="25,0 5,5 5,-5" fill="#1e3a5f" />
        <text x="0" y="-32" text-anchor="middle" fill="#dc2626" font-size="10" font-weight="bold">
          U
        </text>
        <text x="0" y="42" text-anchor="middle" fill="#1e3a5f" font-size="8">
          S
        </text>
        <text x="-35" y="4" text-anchor="middle" fill="#1e3a5f" font-size="8">
          B
        </text>
        <text x="35" y="4" text-anchor="middle" fill="#1e3a5f" font-size="8">
          T
        </text>
        </g> 
        <g transform="translate(50, 470)">
        <rect x="0" y="0" width="100" height="8" fill="white" stroke="#333" />
        <rect x="0" y="0" width="50" height="8" fill="#333" />
        <text x="0" y="20" fill="white" font-size="10">
          0
        </text>
        <text x="50" y="20" fill="white" font-size="10">
          10
        </text>
        <text x="100" y="20" fill="white" font-size="10">
          20 km
        </text>
        </g> 
        <text x="50" y="100" fill="#1e3a5f" font-size="11" font-weight="600" opacity="0.7">
        KAB. PONOROGO â†‘
        </text> 
        <text x="650" y="100" fill="#1e3a5f" font-size="11" font-weight="600" opacity="0.7">
        KAB. TULUNGAGUNG â†’
        </text> 
        <text x="50" y="200" fill="#1e3a5f" font-size="11" font-weight="600" opacity="0.7">
        â† KAB. PACITAN
        </text> 
      </svg>
      <div id="tooltip" class="tooltip" style="display: none;"></div>
      </div>
      <div class="mt-3 grid grid-cols-2 md:grid-cols-4 gap-2 text-xs">
      <div class="legend-item flex items-center gap-2 bg-white/20 rounded-lg px-2 py-1.5">
        <div class="w-4 h-4 rounded" style="background: linear-gradient(#166534, #14532d)"></div><span class="text-white">Pegunungan (&gt;500m)</span>
      </div>
      <div class="legend-item flex items-center gap-2 bg-white/20 rounded-lg px-2 py-1.5">
        <div class="w-4 h-4 rounded" style="background: linear-gradient(#22c55e, #16a34a)"></div><span class="text-white">Perbukitan (100-500m)</span>
      </div>
      <div class="legend-item flex items-center gap-2 bg-white/20 rounded-lg px-2 py-1.5">
        <div class="w-4 h-4 rounded" style="background: linear-gradient(#86efac, #4ade80)"></div><span class="text-white">Dataran Rendah (&lt;100m)</span>
      </div>
      <div class="legend-item flex items-center gap-2 bg-white/20 rounded-lg px-2 py-1.5">
        <div class="w-4 h-4 rounded bg-amber-400"></div><span class="text-white">Ibu Kota / Kecamatan</span>
      </div>
      </div>
    </div>
    <div class="lg:w-1/3 space-y-4">
      <div class="bg-white/95 backdrop-blur-sm rounded-2xl p-4 shadow-xl">
      <h2 id="info-title" class="text-lg font-bold text-emerald-800 mb-3 flex items-center gap-2">ğŸ“ Informasi Wilayah</h2>
      <div id="info-content" class="info-card">
        <div class="text-center py-6 text-gray-500">
        <div class="text-4xl mb-2">
          ğŸ‘†
        </div>
        <p>Klik area pada peta untuk melihat informasi detail</p>
        </div>
      </div>
      </div>
      <div class="bg-white/95 backdrop-blur-sm rounded-2xl p-4 shadow-xl">
      <h3 class="text-sm font-bold text-emerald-800 mb-3">ğŸ“Š Data Geografis</h3>
      <div class="grid grid-cols-2 gap-3 text-xs">
        <div class="bg-emerald-50 rounded-lg p-2.5 text-center">
        <div class="text-emerald-600 font-bold text-lg">
          1.261,40
        </div>
        <div class="text-gray-600">
          kmÂ² Luas Wilayah
        </div>
        </div>
        <div class="bg-blue-50 rounded-lg p-2.5 text-center">
        <div class="text-blue-600 font-bold text-lg">
          14
        </div>
        <div class="text-gray-600">
          Kecamatan
        </div>
        </div>
        <div class="bg-amber-50 rounded-lg p-2.5 text-center">
        <div class="text-amber-600 font-bold text-lg">
          2/3
        </div>
        <div class="text-gray-600">
          Wilayah Pegunungan
        </div>
        </div>
        <div class="bg-cyan-50 rounded-lg p-2.5 text-center">
        <div class="text-cyan-600 font-bold text-lg">
          96 km
        </div>
        <div class="text-gray-600">
          Garis Pantai
        </div>
        </div>
      </div>
      </div>
      <div class="bg-gradient-to-r from-amber-400 to-orange-400 rounded-2xl p-4 shadow-xl">
      <h3 class="text-sm font-bold text-amber-900 mb-2">ğŸ’¡ Petunjuk Simulasi</h3>
      <ul class="text-xs text-amber-900 space-y-1">
        <li>â€¢ Klik tombol layer untuk menampilkan/sembunyikan</li>
        <li>â€¢ Arahkan kursor ke area untuk melihat nama</li>
        <li>â€¢ Klik area untuk detail informasi geografis</li>
        <li>â€¢ Aktifkan layer Wisata untuk lokasi pariwisata</li>
      </ul>
      </div>
    </div>
    </div>
  </div>

  <!-- MODE: SOAL PENGAYAAN -->
  <div id="mode-soal" class="min-h-full w-full p-4 md:p-6 pt-20" style="display: none;">
    <div class="max-w-4xl mx-auto pb-20">
    <header class="text-center mb-6">
      <h1 class="text-3xl font-bold text-white drop-shadow-lg">ğŸ“ Soal Pengayaan Geografi</h1>
      <p class="text-emerald-200 mt-2">Jawablah pertanyaan berdasarkan pengamatan lingkungan sekitarmu</p>
    </header>
    <div class="bg-white/95 backdrop-blur-sm rounded-2xl p-6 shadow-xl">
      <form id="form-pengayaan" onsubmit="submitJawaban(event)">
      <div class="mb-6 p-4 bg-blue-50 rounded-xl">
        <h3 class="text-lg font-bold text-blue-800 mb-4">ğŸ“‹ Data Siswa</h3>
        <div class="space-y-3">
        <div>
          <label for="nama" class="block text-sm font-medium text-gray-700 mb-1">Nama Lengkap</label> 
          <input type="text" id="nama" name="nama" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Masukkan nama lengkap">
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div>
          <label for="no_absen" class="block text-sm font-medium text-gray-700 mb-1">No. Absen</label> 
          <input type="text" id="no_absen" name="no_absen" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="No. absen">
          </div>
          <div>
          <label for="kelas" class="block text-sm font-medium text-gray-700 mb-1">Kelas</label> 
          <input type="text" id="kelas" name="kelas" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Contoh: X IPS 1">
          </div>
        </div>
        </div>
      </div>
      <div class="mb-6 p-4 bg-emerald-50 rounded-xl">
        <h4 class="font-bold text-emerald-800 mb-2">Soal 1: Arsitektur &amp; Iklim Lokal</h4>
        <p class="text-gray-700 text-sm mb-3 leading-relaxed">Perhatikan rumah-rumah tua (bukan bangunan modern baru) di sekitarmu. Apakah kebanyakan memiliki ventilasi udara yang besar atau justru tertutup rapat? Hubungkan pengamatanmu dengan suhu rata-rata di kecamatanmu saat malam hari dibandingkan dengan suhu di pusat kota Trenggalek. Mengapa arsitektur lokalnya demikian?</p>
        <textarea id="jawaban_1" name="jawaban_1" required rows="4" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent" placeholder="Tuliskan pengamatanmu..."></textarea>
      </div>
      <div class="mb-6 p-4 bg-amber-50 rounded-xl">
        <h4 class="font-bold text-amber-800 mb-2">Soal 2: Topografi &amp; Fisika Kendaraan</h4>
        <p class="text-gray-700 text-sm mb-3 leading-relaxed">Ingatlah perjalananmu dari rumah menuju sekolah. Identifikasi satu tanjakan yang paling curam. Jika ada truk bermuatan berat lewat di sana, mengapa mereka harus menggunakan gigi rendah (suara mesin meraung)? Jelaskan hubungannya dengan gaya gravitasi dan kemiringan lereng di daerahmu.</p>
        <textarea id="jawaban_2" name="jawaban_2" required rows="4" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent" placeholder="Tuliskan pengamatanmu..."></textarea>
      </div>
      <div class="mb-6 p-4 bg-blue-50 rounded-xl">
        <h4 class="font-bold text-blue-800 mb-2">Soal 3: Dampak Sosial Pembangunan Infrastruktur</h4>
        <p class="text-gray-700 text-sm mb-3 leading-relaxed">Sejak Jalur Lintas Selatan (JLS) dibuka melintasi kecamatanmu, amati perubahan jenis mata pencaharian tetanggamu. Apakah ada yang beralih dari nelayan/petani menjadi pedagang jasa wisata? Menurutmu, apakah perubahan bentang alam (pembangunan jalan) selalu membawa dampak positif bagi kondisi sosial warga asli? Berikan satu contoh nyata yang kamu lihat.</p>
        <textarea id="jawaban_3" name="jawaban_3" required rows="4" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Tuliskan pengamatanmu..."></textarea>
      </div>
      <div class="mb-6 p-4 bg-red-50 rounded-xl">
        <h4 class="font-bold text-red-800 mb-2">Soal 4: Penyerapan Kalor &amp; Urban Heat Island</h4>
        <p class="text-gray-700 text-sm mb-3 leading-relaxed">Bandingkan rasanya berdiri di tengah Alun-Alun (atau jalan aspal) saat siang hari dengan berdiri di bawah pohon trembesi di pinggir jalan. Mengapa suhu di area yang banyak beton/aspal terasa jauh lebih panas menyengat? Jelaskan konsep 'penyerapan kalor' pada aspal dibandingkan tanah berumput.</p>
        <textarea id="jawaban_4" name="jawaban_4" required rows="4" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" placeholder="Tuliskan pengamatanmu..."></textarea>
      </div>
      <div class="mb-6 p-4 bg-purple-50 rounded-xl">
        <h4 class="font-bold text-purple-800 mb-2">Soal 5: Interdependensi Ekonomi Regional</h4>
        <p class="text-gray-700 text-sm mb-3 leading-relaxed">Jika kamu tinggal di Dongko (penghasil ketela) dan temanmu tinggal di Watulimo (penghasil ikan), bagaimana kondisi geografis tempat tinggal kalian mempengaruhi apa yang kalian makan sehari-hari? Bagaimana proses distribusi makanan (transportasi) memungkinkan orang gunung makan ikan laut dan orang pantai makan sayur? Jelaskan jalur distribusi yang kamu ketahui.</p>
        <textarea id="jawaban_5" name="jawaban_5" required rows="4" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="Tuliskan pengamatanmu..."></textarea>
      </div>

      <div class="flex justify-end pt-4 border-t border-gray-200">
        <button type="submit" id="submit-btn" class="px-6 py-3 bg-gradient-to-r from-blue-600 to-emerald-600 text-white font-bold rounded-xl shadow-lg hover:shadow-xl transform hover:-translate-y-1 transition-all flex items-center">
          ğŸš€ Kirim Jawaban
        </button>
      </div>
      </form>
    </div>
    </div>
  </div>

  <!-- MODE: NILAI SISWA -->
  <div id="mode-nilai" class="min-h-full w-full p-4 md:p-6 pt-20" style="display: none;">
    <div class="max-w-3xl mx-auto">
      <header class="text-center mb-8">
        <h1 class="text-3xl font-bold text-white drop-shadow-lg">ğŸ“ Cek Hasil Penilaian</h1>
        <p class="text-yellow-100 mt-2">Cari namamu untuk melihat nilai dari Bapak/Ibu Guru</p>
      </header>

      <div class="bg-white/95 backdrop-blur-sm rounded-2xl shadow-xl overflow-hidden">
        <div class="p-6 bg-gradient-to-r from-yellow-500 to-orange-500">
          <div class="flex gap-2">
            <input type="text" id="search-nilai" class="w-full px-4 py-3 rounded-lg border-0 focus:ring-2 focus:ring-yellow-300 shadow-inner" placeholder="ğŸ” Cari Nama, Kelas, atau No. Absen..." onkeyup="searchNilai()">
          </div>
        </div>
        <div class="p-6 min-h-[300px] max-h-[500px] overflow-y-auto">
          <div id="hasil-pencarian" class="space-y-4">
            <div class="text-center text-gray-400 py-10">
              <span class="text-4xl block mb-2">ğŸ”</span>
              Ketikkan identitasmu pada kolom pencarian di atas.
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- MODE: PENILAIAN GURU (LOGIN) -->
  <div id="mode-penilaian" class="min-h-full w-full p-4 md:p-6 pt-20 flex justify-center items-start" style="display: none;">
    <!-- Login Panel -->
    <div id="login-panel" class="w-full max-w-md bg-white rounded-2xl shadow-2xl overflow-hidden mt-10">
      <div class="bg-gradient-to-r from-purple-700 to-indigo-800 p-8 text-center">
        <div class="w-16 h-16 bg-white/20 rounded-full flex items-center justify-center mx-auto mb-4 backdrop-blur-sm">
          <span class="text-3xl">ğŸ‘¨â€ğŸ«</span>
        </div>
        <h2 class="text-2xl font-bold text-white">Portal Guru</h2>
        <p class="text-purple-200 text-sm mt-1">Silakan masuk untuk mengakses penilaian</p>
      </div>
      <div class="p-8">
        <form onsubmit="handleLogin(event)">
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
            <input type="text" id="username" class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-purple-500 focus:bg-white transition-all outline-none" placeholder="Masukkan username">
          </div>
          <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
            <input type="password" id="password" class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-purple-500 focus:bg-white transition-all outline-none" placeholder="Masukkan password">
          </div>
          <div id="login-error" class="hidden mb-4 p-3 bg-red-100 text-red-700 text-sm rounded-lg text-center font-medium">
            âš ï¸ Username atau Password salah!
          </div>
          <button type="submit" class="w-full py-3 bg-purple-600 text-white font-bold rounded-lg shadow-md hover:bg-purple-700 transition-all transform active:scale-95">
            Masuk Dashboard
          </button>
        </form>
      </div>
    </div>

    <!-- Dashboard Panel (Hidden by default) -->
    <div id="guru-dashboard" class="hidden w-full max-w-6xl pb-20">
      <header class="flex justify-between items-center mb-6 bg-white/10 backdrop-blur-md p-4 rounded-xl border border-white/20">
        <div>
          <h1 class="text-2xl font-bold text-white">Dashboard Penilaian</h1>
          <p class="text-purple-200 text-sm">Selamat datang, Guru Cerdas</p>
        </div>
        <button onclick="logoutGuru()" class="px-4 py-2 bg-red-500/80 hover:bg-red-600 text-white rounded-lg text-sm transition-colors">
          ğŸšª Keluar
        </button>
      </header>

      <div class="bg-white rounded-xl shadow-xl overflow-hidden min-h-[400px]">
        <div class="p-6 border-b border-gray-100 flex justify-between items-center">
          <h3 class="font-bold text-gray-800 text-lg">ğŸ“ Hasil Jawaban Siswa</h3>
          <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-xs font-medium" id="total-submissions">0 Pengumpulan</span>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full text-sm text-left">
            <thead class="bg-gray-50 text-gray-600 font-medium border-b border-gray-200">
              <tr>
                <th class="px-6 py-4">Waktu</th>
                <th class="px-6 py-4">Nama Siswa</th>
                <th class="px-6 py-4">Kelas / Absen</th>
                <th class="px-6 py-4 text-center">Nilai</th>
                <th class="px-6 py-4 text-center">Aksi</th>
              </tr>
            </thead>
            <tbody id="submission-table-body" class="divide-y divide-gray-100">
              <!-- Data will be populated here -->
              <tr>
                <td colspan="5" class="px-6 py-12 text-center text-gray-400">
                  <div class="loader"></div> Memuat data...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Detail Modal -->
  <div id="detail-modal" class="fixed inset-0 z-[100] hidden" role="dialog" aria-modal="true">
    <div class="fixed inset-0 bg-black/50 backdrop-blur-sm transition-opacity" onclick="closeModal()"></div>
    <div class="fixed inset-0 z-10 overflow-y-auto">
      <div class="flex min-h-full items-center justify-center p-4 text-center sm:p-0">
        <div class="relative transform overflow-hidden rounded-2xl bg-white text-left shadow-2xl transition-all sm:my-8 sm:w-full sm:max-w-2xl">
          <div class="bg-gradient-to-r from-blue-600 to-indigo-700 px-6 py-4 flex justify-between items-center">
            <h3 class="text-xl font-bold text-white flex items-center gap-2">
              ğŸ“„ Detail Jawaban Siswa
            </h3>
            <button onclick="closeModal()" class="text-white/80 hover:text-white text-2xl font-bold">&times;</button>
          </div>
          <div class="px-6 py-6 max-h-[70vh] overflow-y-auto" id="modal-content">
            <!-- Content filled by JS -->
          </div>
          <div class="bg-gray-50 px-6 py-4 flex flex-row-reverse sm:px-6 border-t border-gray-100">
            <button type="button" class="mt-3 inline-flex w-full justify-center rounded-lg bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 sm:mt-0 sm:w-auto" onclick="closeModal()">Tutup</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // --- MAP LOGIC ---
    function switchMode(modeName) {
      // Hide all main containers
      document.getElementById('mode-map').style.display = 'none';
      document.getElementById('mode-soal').style.display = 'none';
      document.getElementById('mode-penilaian').style.display = 'none';
      document.getElementById('mode-nilai').style.display = 'none';
      
      // Reset button styles
      document.getElementById('btn-mode-map').classList.remove('ring-4', 'ring-emerald-300');
      document.getElementById('btn-mode-soal').classList.remove('ring-4', 'ring-blue-300');
      document.getElementById('btn-mode-penilaian').classList.remove('ring-4', 'ring-purple-300');
      document.getElementById('btn-mode-nilai').classList.remove('ring-4', 'ring-yellow-300');

      // Show selected container
      const target = document.getElementById('mode-' + modeName);
      if (modeName === 'penilaian') {
        target.style.display = 'flex'; // Flex for centering login
      } else {
        target.style.display = 'block';
      }

      // Add active ring
      let colorRing = 'ring-emerald-300';
      if(modeName === 'soal') colorRing = 'ring-blue-300';
      if(modeName === 'penilaian') colorRing = 'ring-purple-300';
      if(modeName === 'nilai') colorRing = 'ring-yellow-300';
      
      document.getElementById('btn-mode-' + modeName).classList.add('ring-4', colorRing);

      // Auto Refresh Data saat masuk menu Nilai
      if(modeName === 'nilai' || (modeName === 'penilaian' && !document.getElementById('guru-dashboard').classList.contains('hidden'))) {
        refreshData();
      }
    }

    // Toggle map layers
    function toggleLayer(layerId) {
      const element = document.getElementById(layerId + '-layer');
      const btn = document.getElementById('btn-' + layerId);
      
      if (element.style.display === 'none') {
        element.style.display = 'block';
        btn.classList.add('active');
        btn.classList.remove('opacity-50');
      } else {
        element.style.display = 'none';
        btn.classList.remove('active');
        btn.classList.add('opacity-50');
      }
    }

    // Tooltip logic
    const tooltip = document.getElementById('tooltip');
    function showTooltip(evt, text) {
      tooltip.style.display = 'block';
      tooltip.innerHTML = text;
      tooltip.style.left = (evt.pageX + 10) + 'px';
      tooltip.style.top = (evt.pageY + 10) + 'px';
    }

    function hideTooltip() {
      tooltip.style.display = 'none';
    }

    // Region Info logic
    const regionData = {
      'coastal': { title: 'Kawasan Pesisir', desc: 'Wilayah selatan Trenggalek berbatasan langsung dengan Samudra Hindia. Memiliki potensi perikanan dan pariwisata pantai yang besar. Rawan tsunami namun subur untuk kelapa.' },
      'hills': { title: 'Perbukitan Kapur', desc: 'Mendominasi wilayah tengah. Cocok untuk tanaman keras seperti Jati dan Cengkeh. Tanah cenderung tandus di musim kemarau.' },
      'mountains': { title: 'Pegunungan Wilis', desc: 'Bagian utara berbatasan dengan Ponorogo. Merupakan daerah tangkapan hujan vital. Suhu sejuk, cocok untuk perkebunan kopi dan susu sapi.' },
      'trenggalek-city': { title: 'Kota Trenggalek', desc: 'Pusat pemerintahan dan ekonomi. Terletak di cekungan (basin) yang dikelilingi perbukitan, sehingga rawan banjir kiriman.' },
      'watulimo': { title: 'Kec. Watulimo', desc: 'Sentra pariwisata (Prigi, Pasir Putih) dan pelabuhan perikanan terbesar di pesisir selatan Jawa Timur.' },
      'munjungan': { title: 'Kec. Munjungan', desc: 'Sering disebut "Trenggalek Kecil" karena aksesnya yang terisolir pegunungan curam namun memiliki pusat ekonomi mandiri yang ramai.' },
      'prigi': { title: 'Pantai Prigi', desc: 'Pantai landai dengan pelabuhan perikanan nusantara. Pusat ekonomi maritim.' },
      'dongko': { title: 'Kec. Dongko', desc: 'Dataran tinggi dengan suhu sejuk. Penghasil cengkeh dan ketela.' },
      // Default fallback
      'default': { title: 'Informasi Wilayah', desc: 'Klik area spesifik untuk melihat detail geografis.' }
    };

    function showRegionInfo(id) {
      const info = regionData[id] || { title: id.charAt(0).toUpperCase() + id.slice(1), desc: 'Informasi detail belum tersedia untuk wilayah ini.' };
      
      const contentDiv = document.getElementById('info-content');
      const titleEl = document.getElementById('info-title');
      
      // Animate out
      contentDiv.style.opacity = '0';
      contentDiv.style.transform = 'translateY(10px)';
      
      setTimeout(() => {
        titleEl.innerHTML = `ğŸ“ ${info.title}`;
        contentDiv.innerHTML = `<p class="text-gray-700 leading-relaxed text-sm">${info.desc}</p>`;
        
        // Animate in
        contentDiv.style.opacity = '1';
        contentDiv.style.transform = 'translateY(0)';
      }, 200);
    }

    // --- SOAL PENGAYAAN LOGIC ---
    
    // GANTI URL INI DENGAN URL WEB APP ANDA DARI GOOGLE APPS SCRIPT
    const GOOGLE_SCRIPT_URL = 'PASTE_YOUR_WEB_APP_URL_HERE';

    function submitJawaban(e) {
      e.preventDefault();
      
      // UI Feedback - Show loading
      const submitBtn = document.getElementById('submit-btn');
      const originalBtnText = submitBtn.innerHTML;
      submitBtn.innerHTML = '<div class="loader"></div> Mengirim...';
      submitBtn.disabled = true;

      const formData = new FormData(e.target);
      const data = Object.fromEntries(formData.entries());
      
      // Add timestamp and empty score
      data.timestamp = new Date().toLocaleString('id-ID');
      data.nilai = null; // Default null until graded
      data.action = 'submit'; // Penanda untuk Server
      
      // 1. SIMPAN KE LOCALSTORAGE (Sebagai Backup & Tampilan Instan)
      let submissions = JSON.parse(localStorage.getItem('trenggalek_submissions') || '[]');
      submissions.push(data);
      localStorage.setItem('trenggalek_submissions', JSON.stringify(submissions));
      
      // 2. KIRIM KE GOOGLE SHEET
      if (GOOGLE_SCRIPT_URL !== 'PASTE_YOUR_WEB_APP_URL_HERE') {
        fetch(GOOGLE_SCRIPT_URL, {
          method: 'POST',
          mode: 'no-cors',
          cache: 'no-cache',
          headers: { 'Content-Type': 'application/json' },
          redirect: 'follow',
          body: JSON.stringify(data)
        })
        .then(response => {
           alert(`Terima kasih, ${data.nama}! Jawabanmu telah tersimpan di Server & Lokal.`);
           e.target.reset();
           finishSubmit();
        })
        .catch(error => {
           console.error('Error:', error);
           alert(`Data tersimpan di LOKAL saja. Gagal kirim ke server: ${error}`);
           finishSubmit();
        });
      } else {
        // Jika URL belum diisi
        setTimeout(() => {
            alert(`Terima kasih, ${data.nama}! Jawabanmu telah tersimpan di PENYIMPANAN LOKAL browser. \n\n(Catatan: Data belum terkirim ke Google Sheet karena URL Script belum dikonfigurasi di file index.html)`);
            e.target.reset();
            finishSubmit();
        }, 1000);
      }

      function finishSubmit() {
        submitBtn.innerHTML = originalBtnText;
        submitBtn.disabled = false;
        
        // Switch back to map or refresh dashboard if logged in
        if (!document.getElementById('guru-dashboard').classList.contains('hidden')) {
            renderDashboard(); // Refresh lokal saja
        }
      }
    }

    // --- SEARCH NILAI SISWA LOGIC ---
    function searchNilai() {
      const query = document.getElementById('search-nilai').value.toLowerCase();
      const container = document.getElementById('hasil-pencarian');
      const submissions = JSON.parse(localStorage.getItem('trenggalek_submissions') || '[]');
      
      if(query.length < 2) {
        container.innerHTML = `
          <div class="text-center text-gray-400 py-10">
            <span class="text-4xl block mb-2">ğŸ”</span>
            Ketikkan nama, kelas, atau nomor absen...
          </div>
        `;
        return;
      }

      const results = submissions.filter(sub => 
        sub.nama.toLowerCase().includes(query) || 
        sub.kelas.toLowerCase().includes(query) || 
        sub.no_absen.includes(query)
      );

      if (results.length === 0) {
        container.innerHTML = `
          <div class="text-center text-red-400 py-10 bg-red-50 rounded-lg border border-red-100">
            <span class="text-2xl block mb-2">âŒ</span>
            Data tidak ditemukan. Pastikan kamu sudah mengirim jawaban.
          </div>
        `;
        return;
      }

      let html = '';
      results.reverse().forEach(sub => {
        let scoreBadge = '';
        if (sub.nilai === null || sub.nilai === undefined || sub.nilai === "") {
          scoreBadge = `<span class="bg-gray-200 text-gray-600 px-3 py-1 rounded-full text-xs font-bold">â³ Belum Dinilai</span>`;
        } else {
          const scoreColor = parseInt(sub.nilai) >= 75 ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700';
          scoreBadge = `<span class="${scoreColor} px-3 py-1 rounded-full text-xl font-bold">${sub.nilai}</span>`;
        }

        html += `
          <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 hover:shadow-md transition-all flex justify-between items-center">
            <div>
              <h4 class="font-bold text-gray-800">${sub.nama}</h4>
              <p class="text-sm text-gray-500">${sub.kelas} â€¢ No. ${sub.no_absen}</p>
              <p class="text-xs text-gray-400 mt-1">Dikirim: ${sub.timestamp}</p>
            </div>
            <div class="text-right">
              <div class="text-xs text-gray-400 mb-1">Nilai Akhir</div>
              ${scoreBadge}
            </div>
          </div>
        `;
      });
      container.innerHTML = html;
    }

    // --- PENILAIAN GURU (LOGIN) LOGIC ---
    const CREDENTIALS = {
      u: 'gurucerdas',
      p: '123456'
    };

    function handleLogin(e) {
      e.preventDefault();
      const u = document.getElementById('username').value;
      const p = document.getElementById('password').value;
      const errorMsg = document.getElementById('login-error');

      if (u === CREDENTIALS.u && p === CREDENTIALS.p) {
        // Success
        errorMsg.classList.add('hidden');
        document.getElementById('login-panel').classList.add('hidden');
        document.getElementById('guru-dashboard').classList.remove('hidden');
        
        // Load Data from Server to ensure fresh state
        renderDashboard(true);
      } else {
        // Fail
        errorMsg.classList.remove('hidden');
        // Shake animation
        const panel = document.getElementById('login-panel');
        panel.classList.add('animate-pulse');
        setTimeout(() => panel.classList.remove('animate-pulse'), 500);
      }
    }

    function logoutGuru() {
      document.getElementById('guru-dashboard').classList.add('hidden');
      document.getElementById('login-panel').classList.remove('hidden');
      document.getElementById('username').value = '';
      document.getElementById('password').value = '';
    }

    // Variabel global untuk menyimpan data sementara agar bisa diakses oleh viewDetail & gradeSubmission
    let currentSubmissionsData = [];

    async function renderDashboard(forceFetch = false) {
      const tbody = document.getElementById('submission-table-body');
      
      // Jika forceFetch, tampilkan loading. Jika tidak (hanya update lokal), jangan loading.
      if(forceFetch) {
        tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-12 text-center text-gray-400"><div class="loader"></div> Sinkronisasi data...</td></tr>';
      }
      
      let submissions = [];

      // 1. Coba ambil dari Google Sheet (Jika URL valid & forceFetch)
      if (forceFetch && GOOGLE_SCRIPT_URL !== 'PASTE_YOUR_WEB_APP_URL_HERE') {
        try {
           const response = await fetch(GOOGLE_SCRIPT_URL);
           const data = await response.json();
           if(Array.isArray(data)) {
             submissions = data;
             localStorage.setItem('trenggalek_submissions', JSON.stringify(submissions));
           }
        } catch (e) {
           console.log('Gagal ambil data Google Sheet, gunakan LocalStorage fallback', e);
           submissions = JSON.parse(localStorage.getItem('trenggalek_submissions') || '[]');
        }
      } else {
         submissions = JSON.parse(localStorage.getItem('trenggalek_submissions') || '[]');
      }

      // Simpan ke variabel global
      currentSubmissionsData = submissions;

      document.getElementById('total-submissions').innerText = `${submissions.length} Pengumpulan`;

      if (submissions.length === 0) {
        tbody.innerHTML = `<tr><td colspan="5" class="px-6 py-12 text-center text-gray-400">Belum ada data siswa yang masuk.<br><span class="text-xs">Cobalah mengisi formulir di menu "Soal Pengayaan" sebagai siswa.</span></td></tr>`;
        return;
      }

      let html = '';
      // Show newest first
      const reversedData = [...submissions].reverse();
      
      reversedData.forEach((sub, index) => {
        const originalIndex = submissions.length - 1 - index;
        
        let scoreDisplay = (sub.nilai && sub.nilai !== "") ? `<span class="font-bold text-green-600">${sub.nilai}</span>` : `<span class="text-gray-400 text-xs italic">Belum dinilai</span>`;

        html += `
          <tr class="hover:bg-gray-50 transition-colors">
            <td class="px-6 py-4 text-gray-500 text-xs">${sub.timestamp}</td>
            <td class="px-6 py-4 font-medium text-gray-900">
              ${sub.nama}
            </td>
            <td class="px-6 py-4 text-gray-600">${sub.kelas} / ${sub.no_absen}</td>
            <td class="px-6 py-4 text-center">${scoreDisplay}</td>
            <td class="px-6 py-4 text-center space-x-2">
              <button onclick="viewDetail(${originalIndex})" class="px-3 py-1.5 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded text-xs font-medium transition-colors">ğŸ‘ï¸ Lihat</button>
              <button onclick="gradeSubmission(${originalIndex})" class="px-3 py-1.5 bg-yellow-100 hover:bg-yellow-200 text-yellow-800 rounded text-xs font-bold transition-colors">â­ Beri Nilai</button>
            </td>
          </tr>
        `;
      });
      tbody.innerHTML = html;
    }

    function viewDetail(originalIndex) {
      const data = currentSubmissionsData[originalIndex];
      const modal = document.getElementById('detail-modal');
      const content = document.getElementById('modal-content');
      
      content.innerHTML = `
        <div class="space-y-6">
          <div class="flex items-center gap-4 p-4 bg-blue-50 rounded-xl border border-blue-100">
            <div class="w-12 h-12 rounded-full bg-blue-500 flex items-center justify-center text-white font-bold text-xl">
              ${data.nama.charAt(0)}
            </div>
            <div>
              <h4 class="font-bold text-gray-900 text-lg">${data.nama}</h4>
              <p class="text-sm text-gray-500">${data.kelas} â€¢ Absen ${data.no_absen}</p>
            </div>
          </div>
          
          <div class="space-y-4">
            <div class="p-4 bg-gray-50 rounded-lg border border-gray-100">
              <h5 class="text-xs font-bold text-gray-500 uppercase tracking-wide mb-1">1. Arsitektur & Iklim</h5>
              <p class="text-gray-800 leading-relaxed">${data.jawaban_1}</p>
            </div>
            <div class="p-4 bg-gray-50 rounded-lg border border-gray-100">
              <h5 class="text-xs font-bold text-gray-500 uppercase tracking-wide mb-1">2. Topografi & Kendaraan</h5>
              <p class="text-gray-800 leading-relaxed">${data.jawaban_2}</p>
            </div>
            <div class="p-4 bg-gray-50 rounded-lg border border-gray-100">
              <h5 class="text-xs font-bold text-gray-500 uppercase tracking-wide mb-1">3. Dampak Sosial</h5>
              <p class="text-gray-800 leading-relaxed">${data.jawaban_3}</p>
            </div>
            <div class="p-4 bg-gray-50 rounded-lg border border-gray-100">
              <h5 class="text-xs font-bold text-gray-500 uppercase tracking-wide mb-1">4. Urban Heat</h5>
              <p class="text-gray-800 leading-relaxed">${data.jawaban_4}</p>
            </div>
            <div class="p-4 bg-gray-50 rounded-lg border border-gray-100">
              <h5 class="text-xs font-bold text-gray-500 uppercase tracking-wide mb-1">5. Ekonomi Regional</h5>
              <p class="text-gray-800 leading-relaxed">${data.jawaban_5}</p>
            </div>
          </div>
        </div>
      `;
      
      modal.classList.remove('hidden');
      document.body.classList.add('modal-active');
    }

    function closeModal() {
      const modal = document.getElementById('detail-modal');
      modal.classList.add('hidden');
      document.body.classList.remove('modal-active');
    }

    // --- REVISI FUNGSI PEMBERIAN NILAI ---
    function gradeSubmission(originalIndex) {
      const data = currentSubmissionsData[originalIndex];
      
      let currentScore = data.nilai || '';
      let score = prompt(`Masukkan Nilai untuk ${data.nama} (0-100):`, currentScore);
      
      if (score !== null) {
        if (isNaN(score) || score < 0 || score > 100) {
          alert("Harap masukkan angka valid antara 0 - 100");
          return;
        }
        
        // 1. UPDATE DATA LOKAL (Optimistic Update)
        currentSubmissionsData[originalIndex].nilai = score;
        localStorage.setItem('trenggalek_submissions', JSON.stringify(currentSubmissionsData));
        
        // 2. REFRESH TAMPILAN (Lokal Saja)
        renderDashboard(false); 
        
        // 3. KIRIM UPDATE KE SERVER
        if (GOOGLE_SCRIPT_URL !== 'PASTE_YOUR_WEB_APP_URL_HERE') {
          // Payload Update
          const updateData = {
            action: 'grade',
            nama: data.nama,
            kelas: data.kelas,
            no_absen: data.no_absen,
            nilai: score
          };

          fetch(GOOGLE_SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(updateData)
          })
          .then(() => {
             // Opsional: notif sukses kecil atau log
             console.log("Nilai terkirim ke server");
          })
          .catch(e => {
             alert("Gagal sinkronisasi nilai ke server. Cek koneksi.");
          });
        } else {
          alert("Nilai tersimpan LOKAL.\nURL Script belum disetting, jadi nilai tidak terkirim ke server.");
        }
      }
    }

    // FUNGSI REFRESH DATA (DIPERBAIKI)
    async function refreshData() {
        const btn = document.querySelector('button[title="Perbarui Data"]');
        const originalContent = btn.innerHTML;
        
        // 1. Visual Loading
        btn.innerHTML = 'â³ Loading...';
        btn.disabled = true;
        btn.classList.add('opacity-75', 'cursor-not-allowed');

        try {
            // 2. Cek Mode
            if (GOOGLE_SCRIPT_URL.includes('PASTE_YOUR_WEB_APP_URL_HERE')) {
                alert('PERINGATAN: URL Google Script belum disetting.\nSistem berjalan dalam Mode Offline (Data Lokal Browser).\nData dari siswa lain tidak akan masuk.');
            }

            // 3. Tarik Data (Force Fetch)
            await renderDashboard(true);

            // 4. Update UI Tambahan jika sedang di halaman Nilai
            if (document.getElementById('mode-nilai').style.display !== 'none') {
                searchNilai();
            }

            // 5. Notifikasi Sukses (Singkat)
            // Hanya alert jika tidak di dashboard guru (karena dashboard punya spinner sendiri di tabel)
            if (document.getElementById('guru-dashboard').classList.contains('hidden')) {
               alert('Data berhasil diperbarui!');
            }

        } catch (error) {
            console.error(error);
            alert('Gagal memperbarui data. Cek koneksi internet.');
        } finally {
            // 6. Reset Tombol
            btn.innerHTML = originalContent;
            btn.disabled = false;
            btn.classList.remove('opacity-75', 'cursor-not-allowed');
        }
    }

    // Initial setup
    switchMode('map');
  </script>
 </body>
</html>
